<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.auroral.mapper.OrderMapper">

    <select id="getOrderList" resultType="com.auroral.vo.OrderListVo">
        WITH filtered_orders AS (
            SELECT
                o.order_number,
                o.customer_name,
                o.platform,
                o.phone,
                o.address,
                o.total_amount,
                o.status,
                o.created_at,
                oi.product_id,
                oi.quantity,
                oi.price,
                oi.total_price
            FROM `order` o
                     LEFT JOIN order_items oi ON o.id = oi.order_id
            WHERE
                (#{keyword} IS NULL OR o.customer_name LIKE CONCAT('%', #{keyword}, '%')
                    OR oi.product_id IN (SELECT id FROM product WHERE name LIKE CONCAT('%', #{keyword}, '%')))
              AND (#{status} IS NULL OR o.status = #{status})
              AND (#{platform} IS NULL OR o.platform = #{platform})
              AND o.created_at BETWEEN #{startDate} AND #{endDate}
        )
        SELECT
            fo.order_number AS orderNumber,
            fo.customer_name AS customerName,
            fo.platform AS platform,
            fo.phone AS phone,
            fo.address AS address,
            fo.total_amount AS totalAmount,
            fo.status AS status,
            p.name AS productName,
            fo.quantity AS quantity,
            fo.price AS price,
            fo.total_price AS totalPrice,
            fo.created_at AS createdAt
        FROM filtered_orders fo
                 JOIN product p ON fo.product_id = p.id
        ORDER BY fo.created_at DESC
    </select>

</mapper>
